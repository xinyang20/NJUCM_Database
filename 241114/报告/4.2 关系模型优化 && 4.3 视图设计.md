# 4.2 关系模型优化 && 4.3 视图设计

### **4.2 关系模型优化**

关系模型优化的目标是消除冗余数据和插入、更新、删除异常，确保关系模型满足BCNF（Boyce-Codd范式）的要求。

#### **优化过程**
1. **检查不满足BCNF的关系模式**
   - BCNF要求：在每个非平凡函数依赖 \(X \to Y\) 中，\(X\) 必须是候选键。
   - 检查所有关系模式中的函数依赖。

2. **优化具体关系模式**
   - **患者（patient_id, patient_name, contact_number）**  
     - 满足BCNF，因为 patient_id 是唯一候选键。

   - **医生（doctor_id, doctor_name, department_name）**  
     - 满足BCNF，因为 doctor_id 是唯一候选键。

   - **处方（prescription_id, patient_id, doctor_id, ...）**  
     - 检查依赖：
       - \( prescription_id \to \text{所有其他属性} \)：符合BCNF。
       - 无其他依赖需要分解。

   - **代煎药院（pharmacy_id, pharmacy_name）**  
     - 满足BCNF，因为 pharmacy_id 是唯一候选键。

   - **代煎机器（machine_id, pharmacy_id, machine_status）**  
     - \( machine_id \to \text{所有其他属性} \)：符合BCNF。

   - **煎药记录（decoction_id, prescription_id, pharmacy_id, machine_id, ...）**  
     - \( decoction_id \to \text{所有其他属性} \)：符合BCNF。

**结论**：原设计关系模式均符合BCNF，无需进一步分解。

---

### **4.3 视图设计**

视图设计用于为不同用户提供特定权限的子模式，以提高系统的安全性和使用便捷性。

#### **用户角色**
1. **患者**
   - 主要关注自己的处方、煎药状态和取药信息。
2. **医生**
   - 关注自己开具的处方及其状态。
3. **药房管理员**
   - 管理代煎机器状态、药房的相关信息。
4. **操作员**
   - 负责煎药的具体操作，关注煎药记录。
5. **系统管理员**
   - 拥有系统全局访问权限，维护数据完整性和安全性。

#### **视图设计方案**

1. **患者视图**
   - **视图名**：PatientView  
     - **字段**：prescription_id, prescription_date, prescription_status, pickup_method, expected_pickup_time, actual_pickup_time  
     - **权限**：仅允许查询与登录用户（patient_id）相关的记录。  
     - **定义**：
       ```sql
       CREATE VIEW PatientView AS
       SELECT prescription_id, prescription_date, pickup_method, expected_pickup_time, actual_pickup_time
       FROM 处方
       WHERE patient_id = CURRENT_USER;
       ```

2. **医生视图**
   - **视图名**：DoctorView  
     - **字段**：prescription_id, patient_id, prescription_date, prescription_status, usage_instructions  
     - **权限**：仅允许查询与医生（doctor_id）相关的处方。  
     - **定义**：
       ```sql
       CREATE VIEW DoctorView AS
       SELECT prescription_id, patient_id, prescription_date, usage_instructions
       FROM 处方
       WHERE doctor_id = CURRENT_USER;
       ```

3. **药房管理员视图**
   - **视图名**：PharmacyAdminView  
     - **字段**：pharmacy_id, pharmacy_name, machine_id, machine_status  
     - **权限**：管理药房和代煎机器状态，限制更新权限。  
     - **定义**：
       ```sql
       CREATE VIEW PharmacyAdminView AS
       SELECT pharmacy_id, pharmacy_name, machine_id, machine_status
       FROM 代煎药院
       JOIN 代煎机器 USING (pharmacy_id);
       ```

4. **操作员视图**
   - **视图名**：OperatorView  
     - **字段**：decoction_id, prescription_id, formulation_staff, soaking_staff, decoction_staff, print_staff  
     - **权限**：限制查询和更新与煎药相关的记录，禁止访问患者信息。  
     - **定义**：
       ```sql
       CREATE VIEW OperatorView AS
       SELECT decoction_id, prescription_id, formulation_staff, soaking_staff, decoction_staff, print_staff
       FROM 煎药记录;
       ```

5. **系统管理员视图**
   - **视图名**：AdminView  
     - **字段**：全字段访问权限  
     - **权限**：系统全局访问和维护权限。  
     - **定义**：
       ```sql
       CREATE VIEW AdminView AS
       SELECT * FROM 所有表;
       ```

#### **安全性考虑**
- **权限控制**：
  - 使用数据库角色管理访问权限，仅分配特定视图的访问权限。
  - 例如，患者仅分配 `SELECT` 权限，禁止修改。
- **数据加密**：
  - 对敏感数据（如联系方式）进行加密存储。
- **审计日志**：
  - 启用日志记录用户对视图的访问，确保操作可追溯。
