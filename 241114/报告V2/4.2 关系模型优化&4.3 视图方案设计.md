### 4.2 关系模型优化

#### 4.2.1 检查不满足 BCNF 的关系模式

检查每个关系模式的功能依赖，确认是否符合 BCNF。

1）**用户表（users）** 
符合 BCNF。 
无其他依赖需要分解。  

2）**患者表（patients）** 
符合 BCNF。  

3）**医生表（doctors）** 
符合 BCNF。  

4）**工人表（workers）** 
符合 BCNF。  

5）**管理员表（admins）** 
符合 BCNF。  

6）**处方表（prescriptions）** 
符合 BCNF。  

7）**任务表（tasks）** 
符合 BCNF。  

#### 4.2.2 优化具体关系模式

所有关系均已满足BCNF要求，无需优化。

#### 4.2.3 结论

原设计关系模式均符合 BCNF，无需进一步分解。

---

### 4.3 视图设计

视图设计用于为不同用户提供特定权限的子模式，以提高系统的安全性和使用便捷性。

#### 4.3.1 用户角色

1）患者：关注自己的处方、煎药状态和取药信息。 
2）医生：关注自己开具的处方及其状态。 
3）管理员：管理系统全局信息，维护数据安全性。 
4）操作员：关注与煎药相关的任务及记录。 
5）药房管理员：管理药房和代煎机器状态。

#### 4.3.2 视图设计方案

1）**患者视图** 
**视图名**：PatientView 
**字段**：prescription_id, date, status, usage_instructions, expected_pickup_time 
**权限**：仅允许查询与登录用户（patient_id）相关的记录。 
**视图定义**：

```sql
CREATE VIEW PatientView AS
SELECT prescription_id, date, status, usage_instructions, expected_pickup_time
FROM prescriptions
WHERE patient_id = CURRENT_USER;
```

2）**医生视图** 
**视图名**：DoctorView 
**字段**：prescription_id, patient_id, date, status, usage_instructions 
**权限**：仅允许查询与医生（doctor_id）相关的处方。 
**视图定义**：

```sql
CREATE VIEW DoctorView AS
SELECT prescription_id, patient_id, date, status, usage_instructions
FROM prescriptions
WHERE doctor_id = CURRENT_USER;
```

3）**管理员视图** 
**视图名**：AdminView 
**字段**：全字段访问权限。 
**权限**：系统全局访问权限。 
**视图定义**：

```sql
CREATE VIEW AdminView AS
SELECT * FROM users
UNION ALL
SELECT * FROM patients
UNION ALL
SELECT * FROM doctors
UNION ALL
SELECT * FROM workers
UNION ALL
SELECT * FROM prescriptions
UNION ALL
SELECT * FROM tasks;
```

4）**工人视图** 
**视图名**：WorkerView 
**字段**：task_id, prescription_id, receive_worker_name, form_worker_name, decoction_worker_name, receive_time, form_time, decoction_start_time, decoction_end_time, status 
**权限**：限制查询和更新煎药相关记录，禁止访问患者信息。 
**视图定义**：

```sql
CREATE VIEW WorkerView AS
SELECT task_id, prescription_id, receive_worker_name, form_worker_name, decoction_worker_name, receive_time, form_time, decoction_start_time, decoction_end_time, status
FROM tasks;
```

#### 4.3.3 安全性考虑

1）**权限控制**：  
- 不同用户角色仅能访问对应视图，避免越权。  
- 使用数据库角色管理，如 `GRANT SELECT ON PatientView TO PatientsRole`。  

2）**数据加密**：  
- 加密存储敏感信息（如密码、联系方式），防止数据泄露。  

3）**审计日志**：  
- 启用日志记录用户访问视图的行为，确保操作可追溯。
