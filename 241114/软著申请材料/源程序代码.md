**admin_profile.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员个人信息</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .profile-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .profile-container h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-container p {
            margin: 10px 0;
        }

        .edit-button {
            margin-top: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
        }

        .edit-button:hover {
            background-color: #0056b3;
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            width: 300px;
        }

        .modal.active {
            display: block;
        }

        .modal-header {
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .modal button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
        }

        .modal button:hover {
            background-color: #0056b3;
        }

        .modal .close-button {
            background-color: #d9534f;
        }

        .modal .close-button:hover {
            background-color: #c9302c;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>管理员信息</h1>

    <!-- 显示管理员信息 -->
    <table>
        <tr>
            <th>UUID</th>
            <td>{{ session.get('user_id') }}</td>
        </tr>
        <tr>
            <th>管理员 ID</th>
            <td>{{ admin.admin_id }}</td>
        </tr>
        <tr>
            <th>姓名</th>
            <td>{{ admin.name }}</td>
        </tr>
        <tr>
            <th>联系方式</th>
            <td>{{ admin.contact_number }}</td>
        </tr>
    </table>

    <!-- 居中的编辑按钮 -->
    <div style="margin-top: 20px; text-align: center;">
        <button class="edit-button" onclick="openModal()">编辑信息</button>
    </div>

    <!-- 编辑信息弹窗 -->
    <div class="modal" id="editModal">
        <form method="POST">
            <div class="modal-header">编辑个人信息</div>
            <input type="text" id="name" name="name" placeholder="姓名" value="{{ admin.name }}" required>
            <input type="text" id="contact_number" name="contact_number" placeholder="联系方式" value="{{ admin.contact_number }}" required>
            <button type="submit">保存修改</button>
            <button type="button" class="close-button" onclick="closeModal()">取消</button>
        </form>
    </div>

    <footer>
        © 2024 中药代煎 系统
    </footer>

    <script>
        // 打开弹窗
        function openModal() {
            document.getElementById('editModal').classList.add('active');
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }
    </script>
</body>
</html>
```

**admin_users.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .pagination {
            text-align: center;
            margin: 20px 0;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .pagination button.active {
            background-color: #007bff;
            color: white;
            border: none;
        }
        .filter-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            text-align: center;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f4f4f4;
        }
        .delete-button {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .delete-button:hover {
            background-color: darkred;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h2>用户管理</h2>
    <form method="POST" action="/admin/users" style="margin-bottom: 20px;">
        <h3 align="center">添加用户</h3>
        <label for="username">用户名:</label>
        <input type="text" id="username" name="username" placeholder="用户名" required oninput="checkUsername()">
        <span id="username-message" style="font-size: 0.9em; color: gray;">请输入用户名</span>

        <label for="password">密码:</label>
        <input type="text" id="password" name="password" placeholder="密码" value="123456" required>

        <label for="role-select">角色:</label>
        <select name="role" id="role-select" onchange="updateRoleForm()" required>
            <option value="">选择角色</option>
            <option value="patient">患者</option>
            <option value="worker">工人</option>
            <option value="admin">管理员</option>
        </select>

        <div id="role-form"></div>
        <button type="submit">添加用户</button>
    </form>

    <div class="filter-container">
        <h3>用户信息</h3>
        <form method="GET" action="/admin/users" style="display: flex; align-items: center; gap: 20px;">
            <div>
                <label for="role-filter">角色:</label>
                <select name="role" id="role-filter">
                    <option value="all" {% if selected_role == 'all' %}selected{% endif %}>所有角色</option>
                    <option value="patient" {% if selected_role == 'patient' %}selected{% endif %}>患者</option>
                    <option value="doctor" {% if selected_role == 'doctor' %}selected{% endif %}>医生</option>
                    <option value="worker" {% if selected_role == 'worker' %}selected{% endif %}>工人</option>
                    <option value="admin" {% if selected_role == 'admin' %}selected{% endif %}>管理员</option>
                </select>
            </div>
            <div>
                <label for="username-search">用户名:</label>
                <input type="text" id="username-search" name="username" placeholder="输入用户名" value="{{ request.args.get('username', '') }}">
            </div>
            <button type="submit">查询</button>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>UUID</th>
                <th>用户名</th>
                <th>角色</th>
                <th>角色 ID</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="userTable">
            {% for user in users %}
            <tr class="user-row">
                <td>{{ user.uuid }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.role }}</td>
                <td>{{ user.role_id }}</td>
                <td>
                    <a href="/admin/users/edit/{{ user.uuid }}">编辑</a>
                    <button class="delete-button" onclick="openDeleteModal('{{ user.uuid }}')">删除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="pagination">
        {% for page_num in range(1, total_pages + 1) %}
            <button class="{{ 'active' if page_num == current_page else '' }}" onclick="changePage({{ page_num }})">{{ page_num }}</button>
        {% endfor %}
    </div>

    <!-- 删除确认弹窗 -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteModal()">&times;</span>
            <h2>确认删除用户</h2>
            <form id="deleteForm" method="POST" action="">
                <label for="deletePassword">输入密码确认:</label>
                <input type="password" id="deletePassword" name="password" required>
                <button type="submit">确认删除</button>
            </form>
        </div>
    </div>

    <footer>
        © 2024 中药代煎 系统
    </footer>

    <script>

        function changePage(pageNum) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', pageNum);
            window.location.href = url.toString();
        }

        function openDeleteModal(uuid) {
            const modal = document.getElementById('deleteModal');
            const form = document.getElementById('deleteForm');
            form.action = `/admin/users/delete/${uuid}`;
            modal.style.display = 'block';
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.style.display = 'none';
        }

        async function checkUsername() {
            const usernameInput = document.getElementById('username');
            const messageSpan = document.getElementById('username-message');
            const username = usernameInput.value.trim();
            if (!username) {
                messageSpan.textContent = '用户名不能为空';
                messageSpan.style.color = 'red';
                return;
            }
            try {
                const response = await fetch(`/admin/users/validate_username?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                if (data.valid) {
                    messageSpan.textContent = data.message;
                    messageSpan.style.color = 'green';
                } else {
                    messageSpan.textContent = data.message;
                    messageSpan.style.color = 'red';
                }
            } catch (error) {
                messageSpan.textContent = '验证失败，请稍后重试';
                messageSpan.style.color = 'red';
            }
        }

        function updateRoleForm() {
            const role = document.getElementById('role-select').value;
            const roleForm = document.getElementById('role-form');
            roleForm.innerHTML = '';
            if (role === 'patient') {
                roleForm.innerHTML = `
                    <label for="name">姓名:</label>
                    <input type="text" name="name" placeholder="姓名" required>
                    <label for="gender">性别:</label>
                    <select name="gender" required>
                        <option value="">选择性别</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                    <label for="age">年龄:</label>
                    <input type="number" name="age" placeholder="年龄" required>
                    <label for="contact_number">联系方式:</label>
                    <input type="text" name="contact_number" placeholder="联系方式" required>
                `;
            } else if (role === 'worker') {
                roleForm.innerHTML = `
                    <label for="name">姓名:</label>
                    <input type="text" name="name" placeholder="姓名" required>
                    <label for="age">年龄:</label>
                    <input type="number" name="age" placeholder="年龄" required>
                    <label for="contact_number">联系方式:</label>
                    <input type="text" name="contact_number" placeholder="联系方式" required>
                `;
            } else if (role === 'admin') {
                roleForm.innerHTML = `
                    <label for="name">姓名:</label>
                    <input type="text" name="name" placeholder="姓名" required>
                    <label for="contact_number">联系方式:</label>
                    <input type="text" name="contact_number" placeholder="联系方式" required>
                `;
            }
        }
    </script>
</body>
</html>
```

**app.py**

```python
from flask import Flask, render_template, request, redirect, url_for, session, flash , jsonify
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime
import uuid
from flask import jsonify
# 初始化应用
app = Flask(__name__)
app.secret_key = 'your_secret_key'
# 配置 SQL Server 数据库连接
app.config['SQLALCHEMY_DATABASE_URI'] = (
    'mssql+pyodbc://sa:20050317@localhost/SDDB?driver=ODBC+Driver+17+for+SQL+Server'
)
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)
# 数据库模型
class User(db.Model):
    __tablename__ = 'users'
    uuid = db.Column(db.String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    username = db.Column(db.String(50), unique=True, nullable=False)
    password = db.Column(db.String(100), nullable=False)
    role = db.Column(db.String(20), nullable=False)
    role_id = db.Column(db.Integer)
class Patient(db.Model):
    __tablename__ = 'patients'
    patient_id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50))
    gender = db.Column(db.String(10))
    age = db.Column(db.Integer)
    contact_number = db.Column(db.String(15))
class Doctor(db.Model):
    __tablename__ = 'doctors'
    doctor_id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50))
    gender = db.Column(db.String(10))
    department = db.Column(db.String(50))
    title = db.Column(db.String(50))
    contact_number = db.Column(db.String(15))
class Worker(db.Model):
    __tablename__ = 'workers'
    worker_id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50))
    age = db.Column(db.Integer)
    contact_number = db.Column(db.String(15))
class Admin(db.Model):
    __tablename__ = 'admins'
    admin_id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50))
    contact_number = db.Column(db.String(15))
class Prescription(db.Model):
    __tablename__ = 'prescriptions'
    prescription_id = db.Column(db.Integer, primary_key=True)
    patient_id = db.Column(db.Integer, db.ForeignKey('patients.patient_id'))
    doctor_id = db.Column(db.Integer, db.ForeignKey('doctors.doctor_id'))
    date = db.Column(db.DateTime, default=datetime.utcnow)
    amount = db.Column(db.Float)
    usage_instructions = db.Column(db.Text)
    status = db.Column(db.String(20), default='待配方')
    expected_pickup_time = db.Column(db.DateTime)
class Task(db.Model):
    __tablename__ = 'tasks'
    task_id = db.Column(db.Integer, primary_key=True)
    prescription_id = db.Column(db.Integer, db.ForeignKey('prescriptions.prescription_id'))
    receive_worker_id = db.Column(db.Integer, db.ForeignKey('workers.worker_id'))
    receive_worker_name = db.Column(db.String(50))
    form_worker_id = db.Column(db.Integer, db.ForeignKey('workers.worker_id'))
    form_worker_name = db.Column(db.String(50))
    decoction_worker_id = db.Column(db.Integer, db.ForeignKey('workers.worker_id'))
    decoction_worker_name = db.Column(db.String(50))
    admin_id = db.Column(db.Integer, db.ForeignKey('admins.admin_id'))
    admin_name = db.Column(db.String(50))
    receive_time = db.Column(db.DateTime)
    form_time = db.Column(db.DateTime)
    decoction_start_time = db.Column(db.DateTime)
    decoction_end_time = db.Column(db.DateTime)
    status = db.Column(db.String(20), default='未完成')

# 首页
@app.route('/')
def home():
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    return redirect(url_for('login'))

# 登录模块
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        user = User.query.filter_by(username=username, password=password).first()

        if user:  # 用户验证成功
            session['user_id'] = user.uuid
            session['role'] = user.role
            session['username'] = user.username
            # 根据角色设置角色相关的 session 信息
            if user.role == 'patient':
                patient = Patient.query.filter_by(patient_id=user.role_id).first()
                session['name'] = patient.name if patient else '未知患者'
                session['role_id'] = user.role_id  # 存储患者 ID
            elif user.role == 'doctor':
                doctor = Doctor.query.filter_by(doctor_id=user.role_id).first()
                session['name'] = doctor.name if doctor else '未知医生'
                session['role_id'] = user.role_id  # 存储医生 ID
            elif user.role == 'worker':
                worker = Worker.query.filter_by(worker_id=user.role_id).first()
                session['name'] = worker.name if worker else '未知工人'
                session['role_id'] = user.role_id  # 存储工人 ID
            elif user.role == 'admin':
                admin = Admin.query.filter_by(admin_id=user.role_id).first()
                session['name'] = admin.name if admin else '未知管理员'
                session['role_id'] = user.role_id  # 存储管理员 ID
            flash('登录成功!', 'success')
            return redirect(url_for('dashboard'))
        else:
            flash('用户名或密码错误!', 'danger')
    return render_template('login.html')

# 注册模块
@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        # 获取表单数据
        username = request.form.get('username')
        password = request.form.get('password', '123456')  # 默认密码
        name = request.form.get('name')
        gender = request.form.get('gender')
        age = request.form.get('age')
        contact_number = request.form.get('contact_number')
        # 验证角色（只能是患者）
        role = 'patient'
        # 检查用户名是否已存在
        existing_user = User.query.filter_by(username=username).first()
        if existing_user:
            flash(f"用户名 {username} 已存在，请选择其他用户名!", 'danger')
            return redirect(url_for('register'))
        # 创建患者信息
        try:
            new_patient = Patient(name=name, gender=gender, age=age, contact_number=contact_number)
            db.session.add(new_patient)
            db.session.flush()  # 获取生成的 patient_id
            role_id = new_patient.patient_id
            # 创建用户（仅患者角色）
            new_user = User(username=username, password=password, role=role, role_id=role_id)
            db.session.add(new_user)
            db.session.commit()
            flash(f"用户 {username} 注册成功! UUID: {new_user.uuid}, 角色: {role}, 角色ID: {role_id}", 'success')
            return redirect(url_for('login'))  # 注册成功后重定向到登录页面
        except Exception as e:
            db.session.rollback()
            flash(f"注册失败: {str(e)}", 'danger')
    return render_template('register.html')

# 注销模块
@app.route('/logout')
def logout():
    session.clear()
    # flash('已注销!', 'info')
    flash(' ', 'info')
    return redirect(url_for('login'))

# 通用仪表盘
@app.route('/dashboard')
def dashboard():
    if 'user_id' not in session:
        return redirect(url_for('login'))
    return render_template('dashboard.html', role=session.get('role'))

# 管理员查看个人信息
@app.route('/admin/profile', methods=['GET', 'POST'])
def admin_profile():
    if 'user_id' in session and session.get('role') == 'admin':
        admin_id = session.get('role_id')  # 获取管理员的 role_id
        admin = Admin.query.filter_by(admin_id=admin_id).first()
        if request.method == 'POST':
            # 修改管理员信息
            new_name = request.form.get('name')
            new_contact = request.form.get('contact_number')
            if admin:
                admin.name = new_name
                admin.contact_number = new_contact
                db.session.commit()
                flash('个人信息更新成功!', 'success')
                return redirect(url_for('admin_profile'))
            flash('管理员信息更新失败!', 'danger')
        if admin:
            return render_template('admin_profile.html', admin=admin)
        flash('管理员信息未找到!', 'danger')
        return redirect(url_for('dashboard'))
    flash('无权限访问!', 'danger')
    return redirect(url_for('login'))

# 用户管理/添加用户
@app.route('/admin/users', methods=['GET', 'POST'])
def admin_users():
    if 'user_id' in session and session.get('role') == 'admin':
        selected_role = request.args.get('role', 'all')  # 获取筛选的角色，默认为 'all'
        search_username = request.args.get('username', '').strip()  # 获取搜索用户名，默认为空字符串
        page = int(request.args.get('page', 1))  # 获取当前页数，默认为第 1 页
        per_page = 10  # 每页显示用户数量
        if request.method == 'POST':
            # 添加新用户
            username = request.form.get('username')
            password = request.form.get('password', '123456')  # 默认密码
            role = request.form.get('role')
            try:
                if role == 'patient':
                    name = request.form.get('name')
                    gender = request.form.get('gender')
                    age = request.form.get('age')
                    contact_number = request.form.get('contact_number')
                    new_patient = Patient(name=name, gender=gender, age=age, contact_number=contact_number)
                    db.session.add(new_patient)
                    db.session.flush()  # 获取生成的 patient_id
                    role_id = new_patient.patient_id
                elif role == 'worker':
                    name = request.form.get('name')
                    age = request.form.get('age')
                    contact_number = request.form.get('contact_number')
                    new_worker = Worker(name=name, age=age, contact_number=contact_number)
                    db.session.add(new_worker)
                    db.session.flush()  # 获取生成的 worker_id
                    role_id = new_worker.worker_id
                elif role == 'admin':
                    name = request.form.get('name')
                    contact_number = request.form.get('contact_number')
                    new_admin = Admin(name=name, contact_number=contact_number)
                    db.session.add(new_admin)
                    db.session.flush()  # 获取生成的 admin_id
                    role_id = new_admin.admin_id
                else:
                    flash('角色类型错误!', 'danger')
                    return redirect(url_for('admin_users'))
                existing_user = User.query.filter_by(username=username).first()
                if existing_user:
                    flash(f"用户名 {username} 已存在，请选择其他用户名!", 'danger')
                    return redirect(url_for('admin_users'))
                new_user = User(username=username, password=password, role=role, role_id=role_id)
                db.session.add(new_user)
                db.session.commit()
                flash(f"用户 {username} 添加成功! UUID: {new_user.uuid}, 角色: {role}, 角色ID: {role_id}", 'success')
            except Exception as e:
                db.session.rollback()
                flash(f"添加用户失败: {str(e)}", 'danger')
        # 构建查询语句
        query = User.query
        # 按角色筛选
        if selected_role != 'all':
            query = query.filter_by(role=selected_role)
        # 按用户名模糊搜索
        if search_username:
            query = query.filter(User.username.like(f"%{search_username}%"))
        # 获取总用户数
        total_users = query.count()
        # 分页处理
        users = query.order_by(User.role, User.role_id).offset((page - 1) * per_page).limit(per_page).all()
        total_pages = (total_users + per_page - 1) // per_page  # 计算总页数
        return render_template(
            'admin_users.html',
            users=users,
            selected_role=selected_role,
            search_username=search_username,
            current_page=page,
            total_pages=total_pages,  # 传递总页数到前端
        )
    else:
        flash('无权限访问!', 'danger')
        return redirect(url_for('dashboard'))

@app.route('/admin/users/delete/<uuid>', methods=['POST'])
def delete_user(uuid):
    if 'user_id' in session and session.get('role') == 'admin':
        try:
            # 获取要删除的用户
            user = User.query.filter_by(uuid=uuid).first()
            if user:
                role = user.role
                role_id = user.role_id

                # 根据角色删除相应角色表数据
                if role == 'patient':
                    patient = Patient.query.filter_by(patient_id=role_id).first()
                    if patient:
                        db.session.delete(patient)
                elif role == 'worker':
                    worker = Worker.query.filter_by(worker_id=role_id).first()
                    if worker:
                        db.session.delete(worker)
                elif role == 'admin':
                    admin = Admin.query.filter_by(admin_id=role_id).first()
                    if admin:
                        db.session.delete(admin)
                # 删除用户
                db.session.delete(user)
                db.session.commit()
                flash(f"用户 {user.username} 已成功删除", 'success')
            else:
                flash("未找到用户", 'danger')
        except Exception as e:
            db.session.rollback()
            flash(f"删除失败: {str(e)}", 'danger')
    return redirect(url_for('admin_users'))

# 用户名查重
@app.route('/admin/users/validate_username', methods=['GET'])
def validate_username():
    username = request.args.get('username')
    existing_user = User.query.filter_by(username=username).first()
    if existing_user:
        return {'valid': False, 'message': f"用户名 {username} 已存在"}
    return {'valid': True, 'message': f"用户名 {username} 可用"}

# 编辑用户
@app.route('/admin/users/edit/<uuid>', methods=['GET', 'POST'])
def edit_user(uuid):
    if 'user_id' in session and session.get('role') == 'admin':
        user = User.query.get_or_404(uuid)
        # 获取具体角色的信息
        patient = Patient.query.filter_by(patient_id=user.role_id).first() if user.role == 'patient' else None
        doctor = Doctor.query.filter_by(doctor_id=user.role_id).first() if user.role == 'doctor' else None
        worker = Worker.query.filter_by(worker_id=user.role_id).first() if user.role == 'worker' else None
        admin = Admin.query.filter_by(admin_id=user.role_id).first() if user.role == 'admin' else None
        if request.method == 'POST':
            # 修改用户信息
            user.username = request.form.get('username', user.username)
            user.password = request.form.get('password', user.password)
            # 修改对应角色信息
            if user.role == 'patient' and patient:
                patient.name = request.form.get('patient_name', patient.name)
                patient.gender = request.form.get('patient_gender', patient.gender)
                patient.age = request.form.get('patient_age', patient.age)
                patient.contact_number = request.form.get('patient_contact', patient.contact_number)
            elif user.role == 'doctor' and doctor:
                doctor.name = request.form.get('doctor_name', doctor.name)
                doctor.gender = request.form.get('doctor_gender', doctor.gender)
                doctor.department = request.form.get('doctor_department', doctor.department)
                doctor.title = request.form.get('doctor_title', doctor.title)
                doctor.contact_number = request.form.get('doctor_contact', doctor.contact_number)
            elif user.role == 'worker' and worker:
                worker.name = request.form.get('worker_name', worker.name)
                worker.age = request.form.get('worker_age', worker.age)
                worker.contact_number = request.form.get('worker_contact', worker.contact_number)
            elif user.role == 'admin' and admin:
                admin.name = request.form.get('admin_name', admin.name)
                admin.contact_number = request.form.get('admin_contact', admin.contact_number)
            db.session.commit()
            flash(f"用户 {user.username} 更新成功!", 'success')
            return redirect(url_for('admin_users'))
        return render_template('edit_user.html', user=user, patient=patient, doctor=doctor, worker=worker, admin=admin)
    else:
        flash('无权限访问!', 'danger')
        return redirect(url_for('dashboard'))

# 分配任务
@app.route('/admin/assign_tasks', methods=['GET', 'POST'])
def assign_tasks():
    if 'user_id' in session and session.get('role') == 'admin':
        if request.method == 'POST':
            task_id = request.form.get('task_id')
            operation = request.form.get('operation')  # 'assign' or 'rollback'
            print(f"Received operation: {operation} for task_id: {task_id}")
            if operation == 'assign':
                worker_id = int(request.form.get('worker_id'))
                task_type = request.form.get('task_type')  # 'receive', 'formulate', 'decoction'
                # 获取任务和工人信息
                task = Task.query.get_or_404(task_id)
                worker = Worker.query.get_or_404(worker_id)
                # 检查任务分配规则
                print(f"Assigning task {task_id} to worker {worker_id} for task type {task_type}")
                if task_type == 'formulate' and not task.receive_time:
                    print("Error: Receive step not completed")
                    return jsonify({'success': False, 'message': '必须完成收方后才能分配配方任务!'})
                if task_type == 'decoction' and not task.form_time:
                    print("Error: Formulate step not completed")
                    return jsonify({'success': False, 'message': '必须完成配方后才能分配煎药任务!'})
                # 分配任务
                if task_type == 'receive':
                    task.receive_worker_id = worker_id
                    task.receive_worker_name = worker.name
                elif task_type == 'formulate':
                    task.form_worker_id = worker_id
                    task.form_worker_name = worker.name
                elif task_type == 'decoction':
                    task.decoction_worker_id = worker_id
                    task.decoction_worker_name = worker.name
                db.session.commit()
                print(f"Task {task_id} successfully assigned to {worker.name}")
                return jsonify({'success': True, 'message': f'任务 {task_id} 成功分配给工人 {worker.name}!'})
            elif operation == 'rollback':
                rollback_password = request.form.get('rollback_password')
                admin_user = User.query.filter_by(uuid=session['user_id']).first()
                if not admin_user or admin_user.password != rollback_password:
                    return jsonify({'success': False, 'message': '操作密码错误! 无法执行回退操作。'})
                task = Task.query.get_or_404(task_id)
                # 获取回退阶段
                rollback_phase = request.form.get('rollback_phase')
                # 回退逻辑
                if rollback_phase == 'receive' and task.receive_time:
                    task.receive_time = None
                    task.receive_worker_id = None
                    task.receive_worker_name = None
                    task.status = '未完成'  # 状态变为未完成
                    db.session.commit()
                    return jsonify({'success': True, 'message': f"任务 {task_id} 已成功回退到收方前!"})
                elif rollback_phase == 'formulate' and task.form_time:
                    task.form_time = None
                    task.form_worker_id = None
                    task.form_worker_name = None
                    db.session.commit()
                    return jsonify({'success': True, 'message': f"任务 {task_id} 已成功回退到配方前!"})
                else:
                    return jsonify({'success': False, 'message': '无法回退到该阶段。'})

        # 查询任务统计信息
        unfinished_tasks = Task.query.filter(Task.status != '完成').count()
        finished_tasks = Task.query.filter(Task.status == '完成').count()
        stats = {'unfinished_orders': unfinished_tasks, 'finished_orders': finished_tasks}
        tasks = Task.query.order_by(Task.status.desc(), Task.task_id.asc()).all()
        for task in tasks:
            if task.decoction_end_time:
                task.phase_status = "煎药已完成"
            elif task.decoction_start_time:
                task.phase_status = "煎药进行中"
            elif task.form_time:
                task.phase_status = "配方已完成，煎药未完成"
            elif task.receive_time:
                task.phase_status = "收方已完成，配方未完成"
            else:
                task.phase_status = "收方未完成"
        workers = Worker.query.all()
        return render_template('assign_tasks.html', tasks=tasks, workers=workers, stats=stats)
    flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 医生个人信息页面
@app.route('/doctor/profile', methods=['GET', 'POST'])
def doctor_profile():
    if 'user_id' in session and session.get('role') == 'doctor':
        doctor_id = session.get('role_id')
        doctor = Doctor.query.filter_by(doctor_id=doctor_id).first()
        doctor_user = User.query.filter_by(role_id=doctor_id, role='doctor').first()
        if request.method == 'POST':
            # 更新信息
            doctor.name = request.form.get('name')
            doctor.gender = request.form.get('gender')
            doctor.department = request.form.get('department')
            doctor.title = request.form.get('title')
            doctor.contact_number = request.form.get('contact_number')
            # 更新医生 ID
            department_code = {'内科': '01', '外科': '02', '儿科': '03', '妇科': '04'}.get(doctor.department, '00')
            title_code = {'主任医师': '01', '副主任医师': '02', '主治医师': '03', '住院医师': '04'}.get(doctor.title, '00')
            doctor_id_suffix = str(doctor.doctor_id)[-4:]  # 保留原 ID 的后四位
            doctor.doctor_id = int(department_code + title_code + doctor_id_suffix)
            db.session.commit()
            # 提示信息
            flash(
                f"信息更新成功! 新医生 ID: {doctor.doctor_id}, UUID: {doctor_user.uuid}, 姓名: {doctor.name}, 科室: {doctor.department}, 职称: {doctor.title}",
                'success'
            )
            return redirect(url_for('doctor_profile'))
        return render_template('doctor_profile.html', doctor=doctor, doctor_user=doctor_user)
    else:
        flash('无权限访问!', 'danger')
        return redirect(url_for('dashboard'))

# 医生开处方
@app.route('/doctor/prescriptions/new', methods=['GET', 'POST'])
def create_prescription():
    if 'user_id' in session and session.get('role') == 'doctor':
        doctor_id = session.get('role_id')  # 使用 role_id 确保匹配 doctor_id
        if request.method == 'POST':
            # 获取表单数据
            patient_id = request.form.get('patient_id')
            amount = request.form.get('amount')
            usage_instructions = request.form.get('usage_instructions')
            # 创建新处方
            new_prescription = Prescription(
                patient_id=patient_id,
                doctor_id=doctor_id,
                amount=amount,
                usage_instructions=usage_instructions,
                status='待配方'  # 默认状态
            )
            db.session.add(new_prescription)
            db.session.commit()  # 这里提交事务，生成处方ID
            # 获取新生成的处方ID
            prescription_id = new_prescription.prescription_id
            # 创建新任务，仅填写处方id，其他为空
            new_task = Task(
                prescription_id=prescription_id,
                receive_worker_id=None,
                receive_worker_name=None,
                form_worker_id=None,
                form_worker_name=None,
                decoction_worker_id=None,
                decoction_worker_name=None,
                admin_id=None,
                admin_name=None,
                receive_time=None,
                form_time=None,
                decoction_start_time=None,
                decoction_end_time=None,
                status='未完成'  # 默认任务状态
            )
            db.session.add(new_task)
            db.session.commit()  # 提交任务数据
            flash('处方创建成功，并已生成任务!', 'success')
            return redirect(url_for('doctor_prescriptions'))
        # 获取所有患者信息（供下拉选择患者）
        patients = Patient.query.all()
        return render_template('create_prescription.html', patients=patients)
    else:
        flash('无权限访问!', 'danger')
        return redirect(url_for('dashboard'))

# 医生查看处方
@app.route('/doctor/prescriptions')
def doctor_prescriptions():
    if 'user_id' in session and session.get('role') == 'doctor':
        doctor_id = session.get('role_id')  # 使用 role_id 进行匹配
        if doctor_id:
            prescriptions = Prescription.query.filter_by(doctor_id=doctor_id).all()
            prescriptions_with_status = []
            for prescription in prescriptions:
                task = Task.query.filter_by(prescription_id=prescription.prescription_id).first()
                if not task:
                    status = "未分配任务"
                elif not task.receive_time:
                    status = "待收方"
                elif not task.form_time:
                    status = "待配方"
                elif not task.decoction_start_time:
                    status = "待煎药"
                elif not task.decoction_end_time:
                    status = "煎药中"
                else:
                    status = "已完成"
                prescriptions_with_status.append({
                    "prescription": prescription,
                    "status": status
                })
            return render_template('doctor_prescriptions.html', prescriptions=prescriptions_with_status)
        flash('未找到医生信息!', 'danger')
    else:
        flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 医生查看处方详情
@app.route('/doctor/prescriptions/view/<int:prescription_id>', methods=['GET'])
def doctor_prescription_detail(prescription_id):
    if 'user_id' in session and session.get('role') == 'doctor':
        # 获取医生 ID 并验证
        doctor_id = session.get('role_id')
        prescription = Prescription.query.filter_by(prescription_id=prescription_id, doctor_id=doctor_id).first()
        if prescription:
            # 查询任务信息
            task = Task.query.filter_by(prescription_id=prescription_id).first()
            return render_template('doctor_prescription_detail.html', prescription=prescription, task=task)
        flash('未找到该处方或无权限查看!', 'danger')
        return redirect(url_for('doctor_prescriptions'))
    flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 患者个人信息
@app.route('/patient/profile', methods=['GET', 'POST'])
def patient_profile():
    if 'user_id' in session and session.get('role') == 'patient':
        patient_id = session.get('role_id')
        patient = Patient.query.filter_by(patient_id=patient_id).first()
        patient_user = User.query.filter_by(role_id=patient_id, role='patient').first()
        if request.method == 'POST':
            # 更新信息
            patient.name = request.form.get('name')
            patient.gender = request.form.get('gender')
            patient.age = request.form.get('age')
            patient.contact_number = request.form.get('contact_number')
            db.session.commit()
            # 提示信息
            flash(
                f"信息更新成功! 患者 ID: {patient.patient_id}, UUID: {patient_user.uuid}, 姓名: {patient.name}, 年龄: {patient.age}",
                'success'
            )
            return redirect(url_for('patient_profile'))
        return render_template('patient_profile.html', patient=patient, patient_user=patient_user)
    else:
        flash('无权限访问!', 'danger')
        return redirect(url_for('dashboard'))

# 患者查看处方
@app.route('/patient/prescriptions', methods=['GET'])
def patient_prescriptions():
    if 'user_id' in session and session.get('role') == 'patient':
        patient_id = session.get('role_id')  # role_id 对应 patient_id
        if patient_id:
            prescriptions = Prescription.query.filter_by(patient_id=patient_id).all()
            prescriptions_with_status = []
            for prescription in prescriptions:
                task = Task.query.filter_by(prescription_id=prescription.prescription_id).first()
                if not task:
                    status = "未分配任务"
                elif not task.receive_time:
                    status = "待收方"
                elif not task.form_time:
                    status = "待配方"
                elif not task.decoction_start_time:
                    status = "待煎药"
                elif not task.decoction_end_time:
                    status = "煎药中"
                else:
                    status = "已完成"
                prescriptions_with_status.append({
                    "prescription": prescription,
                    "status": status
                })
            return render_template('patient_prescriptions.html', prescriptions=prescriptions_with_status)
        flash('未找到患者信息!', 'danger')
    else:
        flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 患者查看处方详情
@app.route('/patient/prescriptions/view/<int:prescription_id>', methods=['GET'])
def patient_prescription_detail(prescription_id):
    if 'user_id' in session and session.get('role') == 'patient':
        # 获取患者 ID 并验证
        patient_id = session.get('role_id')
        prescription = Prescription.query.filter_by(prescription_id=prescription_id, patient_id=patient_id).first()
        if prescription:
            # 查询任务信息
            task = Task.query.filter_by(prescription_id=prescription_id).first()
            return render_template('patient_prescription_detail.html', prescription=prescription, task=task)
        flash('未找到该处方或无权限查看!', 'danger')
        return redirect(url_for('patient_prescriptions'))
    flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 工人个人信息
@app.route('/worker/profile', methods=['GET'])
def worker_profile():
    if 'user_id' in session and session.get('role') == 'worker':
        # 获取工人 ID 并查询信息
        worker_id = session.get('role_id')
        worker = Worker.query.filter_by(worker_id=worker_id).first()
        if worker:
            return render_template('worker_profile.html', worker=worker)
        flash('未找到工人信息!', 'danger')
        return redirect(url_for('dashboard'))
    flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 工作人员查看任务
@app.route('/worker/tasks', methods=['GET'])
def worker_tasks():
    if 'user_id' in session and session.get('role') == 'worker':
        worker_id = int(session.get('role_id'))
        tasks = Task.query.filter(
            (Task.receive_worker_id == worker_id) |
            (Task.form_worker_id == worker_id) |
            (Task.decoction_worker_id == worker_id)
        ).all()
        return render_template('worker_tasks.html', tasks=tasks)
    flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 工作人员更新任务状态
@app.route('/worker/tasks/update/<int:task_id>', methods=['GET', 'POST'])
def update_task_status(task_id):
    if 'user_id' in session and session.get('role') == 'worker':
        worker_id = int(session.get('role_id'))  # 当前工人 ID
        task = Task.query.get_or_404(task_id)
        # 如果任务已完成，直接跳回任务列表
        if task.status == '完成':
            flash('任务已完成，无法继续更新状态!', 'info')
            return redirect(url_for('worker_tasks'))
        # 验证任务是否分配给当前工人
        if task.receive_worker_id != worker_id and task.form_worker_id != worker_id and task.decoction_worker_id != worker_id:
            flash('无权限操作此任务!', 'danger')
            return redirect(url_for('worker_tasks'))
        if request.method == 'POST':
            action = request.form.get('action')
            # 更新任务状态逻辑
            if action == 'receive' and task.receive_worker_id == worker_id and not task.receive_time:
                task.receive_time = datetime.utcnow()
            elif action == 'formulate' and task.form_worker_id == worker_id and task.receive_time and not task.form_time:
                task.form_time = datetime.utcnow()
            elif action == 'decoction_start' and task.decoction_worker_id == worker_id and task.form_time and not task.decoction_start_time:
                task.decoction_start_time = datetime.utcnow()
            elif action == 'decoction_end' and task.decoction_worker_id == worker_id and task.decoction_start_time and not task.decoction_end_time:
                task.decoction_end_time = datetime.utcnow()
                task.status = '完成'
            else:
                flash('当前任务未满足操作条件，无法完成此操作。', 'warning')
                return redirect(url_for('update_task_status', task_id=task_id))
            db.session.commit()
            flash('任务状态更新成功!', 'success')
            return redirect(url_for('worker_tasks'))
        return render_template('update_task.html', task=task)
    flash('无权限访问!', 'danger')
    return redirect(url_for('dashboard'))

# 初始化数据库
if __name__ == '__main__':
    with app.app_context():
        db.create_all()  # 创建所有表
    app.run(debug=True)
```

**assign_tasks.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务分配</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .worker-name.completed { color: green; }
        .worker-name.uncompleted { color: red; }
        .worker-name.unassigned { color: #ffb700; }
        .small-button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .pagination {
            text-align: center;
            margin: 20px 0;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .pagination button.active {
            background-color: #007bff;
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <div class="container">
        <h1>分配任务</h1>
        <!-- 任务统计 -->
        <h2>任务统计</h2>
        <p>未完成订单数量: {{ stats.unfinished_orders }}</p>
        <p>已完成订单数量: {{ stats.finished_orders }}</p>

        <!-- 任务分配表 -->
        <table border="1" class="table" style="border-collapse: collapse; width: 100%; table-layout: fixed;">
            <thead>
                <tr style="height: 30px;">
                    <th>任务 ID</th>
                    <th>处方 ID</th>
                    <th>当前阶段状态</th>
                    <th>收方工人</th>
                    <th>配方工人</th>
                    <th>煎药工人</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="taskTable">
                {% for task in tasks %}
                <tr class="task-row" style="height: 60px;">
                    <td style="text-align: center;">{{ task.task_id }}</td>
                    <td style="text-align: center;">{{ task.prescription_id }}</td>
                    <td style="text-align: center;">{{ task.phase_status }}</td>
                    <td style="text-align: center;">
                        <span class="worker-name
                            {% if task.receive_time %}
                                completed
                            {% elif task.receive_worker_id %}
                                uncompleted
                            {% else %}
                                unassigned
                            {% endif %}">
                            {{ task.receive_worker_name or '未分配' }}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <span class="worker-name
                            {% if task.form_time %}
                                completed
                            {% elif task.form_worker_id %}
                                uncompleted
                            {% else %}
                                unassigned
                            {% endif %}">
                            {{ task.form_worker_name or '未分配' }}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <span class="worker-name
                            {% if task.decoction_end_time %}
                                completed
                            {% elif task.decoction_worker_id %}
                                uncompleted
                            {% else %}
                                unassigned
                            {% endif %}">
                            {{ task.decoction_worker_name or '未分配' }}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        {% if task.status != '完成' %}
                        <form method="POST" action="{{ url_for('assign_tasks') }}" style="margin-bottom: 5px;">
                            <input type="hidden" name="task_id" value="{{ task.task_id }}">
                            <input type="hidden" name="operation" value="assign">

                            <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
                                <select name="task_type" style="width: 120px; height: 22px; font-size: 12px;" required>
                                    <option value="receive" {% if task.receive_time %}disabled{% endif %}>收方</option>
                                    <option value="formulate" {% if task.form_time %}disabled{% endif %}>配方</option>
                                    <option value="decoction" {% if task.decoction_end_time %}disabled{% endif %}>煎药</option>
                                </select>
                                <select name="worker_id" style="width: 120px; height: 22px; font-size: 12px;" required>
                                    {% for worker in workers %}
                                    <option value="{{ worker.worker_id }}">{{ worker.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" style="margin-top: 5px; font-size: 11px; padding: 3px 8px; width: 70px; height: 25px;">分配</button>
                        </form>

                        <button class="small-button"
                            style="background-color: red; color: white; border: none; padding: 3px 8px; cursor: pointer; margin-top: 5px; width: 70px; height: 25px;"
                            data-task-id="{{ task.task_id }}"
                            data-receive-completed="{{ 'true' if task.receive_time else 'false' }} "
                            data-form-completed="{{ 'true' if task.form_time else 'false' }}"
                            data-decoction-started="{{ 'true' if task.decoction_start_time else 'false' }}"
                            data-decoction-ended="{{ 'true' if task.decoction_end_time else 'false' }}"
                            onclick="openRollbackModal(this)">回退</button>
                        {% else %}
                        <span>任务已完成</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页 -->
    <div class="pagination" id="pagination"></div>

    <!-- 回退任务弹窗 -->
    <div id="rollbackModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRollbackModal()">&times;</span>
            <h2>回退任务</h2>
            <form method="POST" action="{{ url_for('assign_tasks') }}">
                <input type="hidden" name="task_id" id="rollbackTaskId">
                <input type="hidden" name="operation" value="rollback">

                <label for="rollback_phase">选择回退阶段:</label>
                <select name="rollback_phase" id="rollback_phase" required>
                    <option value="receive">回退到收方前</option>
                    <option value="formulate">回退到配方阶段</option>
                    <option value="decoction_start">回退到煎药开始</option>
                    <option value="decoction_end">回退到煎药结束</option>
                </select>
                <label for="rollback_password">确认密码:</label>
                <input type="password" name="rollback_password" id="rollback_password" required>
                <button type="submit">确认回退</button>
            </form>
        </div>
    </div>

    <footer>
        © 2024 中药代煎 系统
    </footer>

    <script>
        const rowsPerPage = 5;
        const rows = document.querySelectorAll('.task-row');
        const pagination = document.getElementById('pagination');

        function displayPage(page) {
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            rows.forEach((row, index) => {
                row.style.display = index >= start && index < end ? '' : 'none';
            });
        }

        function setupPagination() {
            const totalPages = Math.ceil(rows.length / rowsPerPage);
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === 1 ? 'active' : '';
                button.addEventListener('click', () => {
                    document.querySelector('.pagination button.active').classList.remove('active');
                    button.classList.add('active');
                    displayPage(i);
                });
                pagination.appendChild(button);
            }
        }

        displayPage(1);
        setupPagination();

        function openRollbackModal(button) {
            const taskId = button.getAttribute('data-task-id');
            const receiveCompleted = button.getAttribute('data-receive-completed') === 'true';
            const formCompleted = button.getAttribute('data-form-completed') === 'true';
            const decoctionStarted = button.getAttribute('data-decoction-started') === 'true';
            const decoctionEnded = button.getAttribute('data-decoction-ended') === 'true';

            document.getElementById('rollbackModal').style.display = 'block';
            document.getElementById('rollbackTaskId').value = taskId;

            const rollbackPhase = document.getElementById('rollback_phase');
            rollbackPhase.innerHTML = '';

            if (decoctionEnded) {
                rollbackPhase.innerHTML += '<option value="decoction_end">煎药结束</option>';
            }
            if (decoctionStarted) {
                rollbackPhase.innerHTML += '<option value="decoction_start">煎药开始</option>';
            }
            if (formCompleted) {
                rollbackPhase.innerHTML += '<option value="formulate">配方</option>';
            }
            if (receiveCompleted) {
                rollbackPhase.innerHTML += '<option value="receive">收方</option>';
            }

            if (rollbackPhase.innerHTML === '') {
                rollbackPhase.innerHTML = '<option disabled>无可回退阶段</option>';
            }
        }

        function closeRollbackModal() {
            document.getElementById('rollbackModal').style.display = 'none';
        }


        // 监听表单提交
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault(); // 阻止默认提交

                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json(); // 解析返回的 JSON 数据

                if (data.success) {
                    // 成功提示
                    alert(data.message);
                    location.reload(); // 刷新页面，显示新的分配状态
                } else {
                    // 错误提示
                    alert(data.message);
                }
            });
        });
    </script>
</body>
</html>
```

**create_prescription.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建新处方</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>创建新处方</h1>

    <!-- 新处方表单 -->
    <form method="POST">
        <label for="patient_id">选择患者：</label>
        <select name="patient_id" id="patient_id" required>
            <option value="" disabled selected>请选择患者</option>
            {% for patient in patients %}
            <option value="{{ patient.patient_id }}">{{ patient.name }} (ID: {{ patient.patient_id }})</option>
            {% endfor %}
        </select>
        <br><br>

        <label for="amount">总金额：</label>
        <input type="number" step="0.01" name="amount" id="amount" placeholder="输入金额" required>
        <br><br>

        <label for="usage_instructions">用药说明：</label>
        <textarea name="usage_instructions" id="usage_instructions" rows="4" placeholder="输入用药说明" required></textarea>
        <br><br>

        <button type="submit">创建处方</button>
    </form>

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**dashboard.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通用仪表盘</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .dashboard-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }

        .dashboard-options ul {
            list-style: none;
            padding: 0;
        }

        .dashboard-options li {
            margin: 10px 0;
        }

        .dashboard-options a {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }

        .dashboard-options a:hover {
            background-color: #0056b3;
        }

        .profile-link {
            text-align: center;
            margin: 20px 0;
        }

        .profile-link a {
            padding: 10px 20px;
            background-color: #28a745;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1.1em;
        }

        .profile-link a:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1 style="text-align: center;">欢迎, {{ session.get('name') }}</h1>

    <!-- 新增入口 -->
<!--    <div class="profile-link">-->
<!--        <a href="/profile">查看个人信息</a>-->
<!--    </div>-->

    <div class="dashboard-options">
        {% if session['role'] == 'admin' %}
        <ul>
            <li><a href="/admin/profile">个人信息</a></li>
            <li><a href="/admin/users">用户管理</a></li>
            <li><a href="/admin/assign_tasks">分配任务</a></li>
        </ul>
        {% elif session['role'] == 'patient' %}
        <ul>
            <li><a href="/patient/profile">个人信息</a></li>
            <li><a href="/patient/prescriptions">查看处方</a></li>
        </ul>
        {% elif session['role'] == 'doctor' %}
        <ul>
            <li><a href="/doctor/profile">个人信息</a></li>
            <li><a href="/doctor/prescriptions">我的处方</a></li>
            <li><a href="/doctor/prescriptions/new">开新处方</a></li>
        </ul>
        {% elif session['role'] == 'worker' %}
        <ul>
            <li><a href="/worker/profile">个人信息</a></li>
            <li><a href="/worker/tasks">我的任务</a></li>
        </ul>
        {% endif %}
    </div>

    <footer style="text-align: center; margin-top: 20px;">
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**doctor_prescription_detail.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>处方详情</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>处方详情</h1>

    <!-- 显示处方详情 -->
    <h2>基本信息</h2>
    <table>
        <tr>
            <th>处方 ID</th>
            <td>{{ prescription.prescription_id }}</td>
        </tr>
        <tr>
            <th>患者 ID</th>
            <td>{{ prescription.patient_id }}</td>
        </tr>
        <tr>
            <th>金额</th>
            <td>{{ prescription.amount }}</td>
        </tr>
        <tr>
            <th>状态</th>
            <td>{{ prescription.status }}</td>
        </tr>
        <tr>
            <th>开方时间</th>
            <td>{{ prescription.date }}</td>
        </tr>
        <tr>
            <th>预计取药时间</th>
            <td>{{ prescription.expected_pickup_time }}</td>
        </tr>
        <tr>
            <th>用药说明</th>
            <td>{{ prescription.usage_instructions }}</td>
        </tr>
    </table>

    <!-- 显示任务详情 -->
    {% if task %}
    <h2>任务信息</h2>
    <table>
        <tr>
            <th>任务 ID</th>
            <td>{{ task.task_id }}</td>
        </tr>
        <tr>
            <th>收方工人</th>
            <td style="color: {{ 'green' if task.receive_time else 'red' }}">{{ task.receive_worker_name or '未分配' }}</td>
        </tr>
        <tr>
            <th>配方工人</th>
            <td style="color: {{ 'green' if task.form_time else 'red' }}">{{ task.form_worker_name or '未分配' }}</td>
        </tr>
        <tr>
            <th>煎药工人</th>
            <td style="color: {{ 'green' if task.decoction_start_time else 'red' }}">{{ task.decoction_worker_name or '未分配' }}</td>
        </tr>
        <tr>
            <th>收方时间</th>
            <td>{{ task.receive_time or '未完成' }}</td>
        </tr>
        <tr>
            <th>配方时间</th>
            <td>{{ task.form_time or '未完成' }}</td>
        </tr>
        <tr>
            <th>煎药开始时间</th>
            <td>{{ task.decoction_start_time or '未开始' }}</td>
        </tr>
        <tr>
            <th>煎药结束时间</th>
            <td>{{ task.decoction_end_time or '未完成' }}</td>
        </tr>
        <tr>
            <th>任务状态</th>
            <td>{{ task.status }}</td>
        </tr>
    </table>
    {% else %}
    <p>尚未为此处方分配任务。</p>
    {% endif %}

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**doctor_prescriptions.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的处方</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>我的处方</h1>

    <!-- 创建新处方按钮 -->
    <div style="display: flex; justify-content: center; margin-top: 20px;">
        <a href="/doctor/prescriptions/new" class="button" style="background-color: #0066cc; color: white; border: none; border-radius: 4px; padding: 10px 20px; text-decoration: none; font-size: 16px; text-align: center;">
            创建新处方
        </a>
    </div>



    <!-- 显示医生的处方列表 -->
    <h2>处方列表</h2>
    <table>
        <thead>
            <tr>
                <th>处方 ID</th>
                <th>患者 ID</th>
                <th>金额</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in prescriptions %}
            <tr>
                <td>{{ item.prescription.prescription_id }}</td>
                <td>{{ item.prescription.patient_id }}</td>
                <td>{{ item.prescription.amount }}</td>
                <td>{{ item.status }}</td>
                <td>{{ item.prescription.date }}</td>
                <td>
                    <a href="/doctor/prescriptions/view/{{ item.prescription.prescription_id }}">查看详情</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**doctor_profile.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医生个人信息</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .modal.active {
            display: block;
        }
        .modal-header {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
        }
        .close-button {
            background: red;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        .save-button {
            background: green;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>医生信息</h1>

    <!-- 显示医生信息 -->
    <table>
        <tr>
            <th>UUID</th>
            <td>{{ doctor_user.uuid }}</td>
        </tr>
        <tr>
            <th>医生 ID</th>
            <td>{{ doctor.doctor_id }}</td>
        </tr>
        <tr>
            <th>姓名</th>
            <td>{{ doctor.name }}</td>
        </tr>
        <tr>
            <th>性别</th>
            <td>{{ doctor.gender }}</td>
        </tr>
        <tr>
            <th>科室</th>
            <td>{{ doctor.department }}</td>
        </tr>
        <tr>
            <th>职称</th>
            <td>{{ doctor.title }}</td>
        </tr>
        <tr>
            <th>联系方式</th>
            <td>{{ doctor.contact_number }}</td>
        </tr>
    </table>

    <!-- 居中的编辑按钮 -->
    <div style="margin-top: 20px; text-align: center;">
        <button onclick="openModal()">编辑信息</button>
    </div>



    <!-- 编辑信息弹窗 -->
    <div class="modal" id="editModal">
        <form method="POST">
            <div class="modal-header">编辑个人信息</div>
            <label for="name">姓名:</label>
            <input type="text" id="name" name="name" value="{{ doctor.name }}" required>

            <label for="gender">性别:</label>
            <select id="gender" name="gender" required>
                <option value="男" {% if doctor.gender == '男' %}selected{% endif %}>男</option>
                <option value="女" {% if doctor.gender == '女' %}selected{% endif %}>女</option>
            </select>

            <label for="department">科室:</label>
            <select id="department" name="department" required>
                <option value="内科" {% if doctor.department == '内科' %}selected{% endif %}>内科</option>
                <option value="外科" {% if doctor.department == '外科' %}selected{% endif %}>外科</option>
                <option value="儿科" {% if doctor.department == '儿科' %}selected{% endif %}>儿科</option>
                <option value="妇科" {% if doctor.department == '妇科' %}selected{% endif %}>妇科</option>
            </select>

            <label for="title">职称:</label>
            <select id="title" name="title" required>
                <option value="主任医师" {% if doctor.title == '主任医师' %}selected{% endif %}>主任医师</option>
                <option value="副主任医师" {% if doctor.title == '副主任医师' %}selected{% endif %}>副主任医师</option>
                <option value="主治医师" {% if doctor.title == '主治医师' %}selected{% endif %}>主治医师</option>
                <option value="住院医师" {% if doctor.title == '住院医师' %}selected{% endif %}>住院医师</option>
            </select>

            <label for="contact_number">联系方式:</label>
            <input type="text" id="contact_number" name="contact_number" value="{{ doctor.contact_number }}" required>

            <div class="modal-buttons">
                <button type="submit" class="save-button">保存修改</button>
                <button type="button" class="close-button" onclick="closeModal()">取消</button>
            </div>
        </form>
    </div>
    <footer>
        © 2024 中药代煎 系统
    </footer>

    <script>
        // 打开弹窗
        function openModal() {
            document.getElementById('editModal').classList.add('active');
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }
    </script>
</body>
</html>
```

**edit_user.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑用户</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>编辑用户 - {{ user.username }}</h1>
    <form method="POST">
        <label for="username">用户名:</label>
        <input type="text" id="username" name="username" value="{{ user.username }}" required>

        <label for="password">密码:</label>
        <input type="text" id="password" name="password" value="{{ user.password }}" required>

        <label for="role">角色:</label>
        <select id="role" name="role">
            <option value="patient" {% if user.role == 'patient' %}selected{% endif %}>患者</option>
            <option value="doctor" {% if user.role == 'doctor' %}selected{% endif %}>医生</option>
            <option value="worker" {% if user.role == 'worker' %}selected{% endif %}>工人</option>
            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>管理员</option>
        </select>

        {% if user.role == 'patient' %}
        <h3>患者信息</h3>
        <label for="patient_name">姓名:</label>
        <input type="text" id="patient_name" name="patient_name" value="{{ patient.name }}">

        <label for="patient_gender">性别:</label>
        <select id="patient_gender" name="patient_gender">
            <option value="男" {% if patient.gender == '男' %}selected{% endif %}>男</option>
            <option value="女" {% if patient.gender == '女' %}selected{% endif %}>女</option>
        </select>

        <label for="patient_age">年龄:</label>
        <input type="number" id="patient_age" name="patient_age" value="{{ patient.age }}">

        <label for="patient_contact">联系方式:</label>
        <input type="text" id="patient_contact" name="patient_contact" value="{{ patient.contact_number }}">
        {% elif user.role == 'doctor' %}
        <h3>医生信息</h3>
        <label for="doctor_name">姓名:</label>
        <input type="text" id="doctor_name" name="doctor_name" value="{{ doctor.name }}">

        <label for="doctor_gender">性别:</label>
        <select id="doctor_gender" name="doctor_gender">
            <option value="男" {% if doctor.gender == '男' %}selected{% endif %}>男</option>
            <option value="女" {% if doctor.gender == '女' %}selected{% endif %}>女</option>
        </select>

        <label for="doctor_department">科室:</label>
        <input type="text" id="doctor_department" name="doctor_department" value="{{ doctor.department }}">

        <label for="doctor_title">职称:</label>
        <input type="text" id="doctor_title" name="doctor_title" value="{{ doctor.title }}">

        <label for="doctor_contact">联系方式:</label>
        <input type="text" id="doctor_contact" name="doctor_contact" value="{{ doctor.contact_number }}">
        {% elif user.role == 'worker' %}
        <h3>工人信息</h3>
        <label for="worker_name">姓名:</label>
        <input type="text" id="worker_name" name="worker_name" value="{{ worker.name }}">

        <label for="worker_age">年龄:</label>
        <input type="number" id="worker_age" name="worker_age" value="{{ worker.age }}">

        <label for="worker_contact">联系方式:</label>
        <input type="text" id="worker_contact" name="worker_contact" value="{{ worker.contact_number }}">
        {% elif user.role == 'admin' %}
        <h3>管理员信息</h3>
        <label for="admin_name">姓名:</label>
        <input type="text" id="admin_name" name="admin_name" value="{{ admin.name }}">

        <label for="admin_contact">联系方式:</label>
        <input type="text" id="admin_contact" name="admin_contact" value="{{ admin.contact_number }}">
        {% endif %}

        <button type="submit">保存修改</button>
    </form>
    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**login.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
<!--            <a href="/logout">注销</a>-->
        </div>
    </div>
    <h1>登录</h1>
    <form method="POST" action="/login">
        <label for="username">用户名:</label>
        <input type="text" id="username" name="username" required>
        <label for="password">密码:</label>
        <input type="password" id="password" name="password" required>
        <button type="submit">登录</button>
    </form>

    <p>还没有账号？<a href="/register">点击注册</a></p>

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**patient_prescription_detail.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>处方详情</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>处方详情</h1>

    <!-- 显示处方详情 -->
    <h2>基本信息</h2>
    <table>
        <tr>
            <th>处方 ID</th>
            <td>{{ prescription.prescription_id }}</td>
        </tr>
        <tr>
            <th>金额</th>
            <td>{{ prescription.amount }}</td>
        </tr>
        <tr>
            <th>状态</th>
            <td>{{ prescription.status }}</td>
        </tr>
        <tr>
            <th>开方时间</th>
            <td>{{ prescription.date }}</td>
        </tr>
        <tr>
            <th>预计取药时间</th>
            <td>{{ prescription.expected_pickup_time or '未设置' }}</td>
        </tr>
        <tr>
            <th>用药说明</th>
            <td>{{ prescription.usage_instructions }}</td>
        </tr>
    </table>

    <!-- 显示任务详情 -->
    {% if task %}
    <h2>任务信息</h2>
    <table>
        <tr>
            <th>任务 ID</th>
            <td>{{ task.task_id }}</td>
        </tr>
        <tr>
            <th>收方工人</th>
            <td style="color: {{ 'green' if task.receive_time else 'red' }}">{{ task.receive_worker_name or '未分配' }}</td>
        </tr>
        <tr>
            <th>配方工人</th>
            <td style="color: {{ 'green' if task.form_time else 'red' }}">{{ task.form_worker_name or '未分配' }}</td>
        </tr>
        <tr>
            <th>煎药工人</th>
            <td style="color: {{ 'green' if task.decoction_start_time else 'red' }}">{{ task.decoction_worker_name or '未分配' }}</td>
        </tr>
        <tr>
            <th>收方时间</th>
            <td>{{ task.receive_time or '未完成' }}</td>
        </tr>
        <tr>
            <th>配方时间</th>
            <td>{{ task.form_time or '未完成' }}</td>
        </tr>
        <tr>
            <th>煎药开始时间</th>
            <td>{{ task.decoction_start_time or '未开始' }}</td>
        </tr>
        <tr>
            <th>煎药结束时间</th>
            <td>{{ task.decoction_end_time or '未完成' }}</td>
        </tr>
        <tr>
            <th>任务状态</th>
            <td>{{ task.status }}</td>
        </tr>
    </table>
    {% else %}
    <p>尚未为此处方分配任务。</p>
    {% endif %}

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**patient_prescriptions.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的处方</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>我的处方</h1>

    <!-- 显示处方列表 -->
    <table>
        <thead>
            <tr>
                <th>处方 ID</th>
                <th>金额</th>
                <th>状态</th>
                <th>开方时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in prescriptions %}
            <tr>
                <td>{{ item.prescription.prescription_id }}</td>
                <td>{{ item.prescription.amount }}</td>
                <td>{{ item.status }}</td>
                <td>{{ item.prescription.date }}</td>
                <td>
                    <a href="/patient/prescriptions/view/{{ item.prescription.prescription_id }}">查看详情</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**patient_profile.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>患者个人信息</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .modal.active {
            display: block;
        }
        .modal-header {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
        }
        .close-button {
            background: red;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        .save-button {
            background: green;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>患者信息</h1>

    <!-- 显示患者信息 -->
    <table>
        <tr>
            <th>UUID</th>
            <td>{{ patient_user.uuid }}</td>
        </tr>
        <tr>
            <th>患者 ID</th>
            <td>{{ patient.patient_id }}</td>
        </tr>
        <tr>
            <th>姓名</th>
            <td>{{ patient.name }}</td>
        </tr>
        <tr>
            <th>性别</th>
            <td>{{ patient.gender }}</td>
        </tr>
        <tr>
            <th>年龄</th>
            <td>{{ patient.age }}</td>
        </tr>
        <tr>
            <th>联系方式</th>
            <td>{{ patient.contact_number }}</td>
        </tr>
    </table>

    <!-- 居中的编辑按钮 -->
    <div style="margin-top: 20px; text-align: center;">
        <button onclick="openModal()">编辑信息</button>
    </div>


    <!-- 编辑信息弹窗 -->
    <div class="modal" id="editModal">
        <form method="POST">
            <div class="modal-header">编辑个人信息</div>
            <label for="name">姓名:</label>
            <input type="text" id="name" name="name" value="{{ patient.name }}" required>

            <label for="gender">性别:</label>
            <select id="gender" name="gender" required>
                <option value="男" {% if patient.gender == '男' %}selected{% endif %}>男</option>
                <option value="女" {% if patient.gender == '女' %}selected{% endif %}>女</option>
            </select>

            <label for="age">年龄:</label>
            <input type="number" id="age" name="age" value="{{ patient.age }}" min="0" required>

            <label for="contact_number">联系方式:</label>
            <input type="text" id="contact_number" name="contact_number" value="{{ patient.contact_number }}" required>

            <div class="modal-buttons">
                <button type="submit" class="save-button">保存修改</button>
                <button type="button" class="close-button" onclick="closeModal()">取消</button>
            </div>
        </form>
    </div>

    <footer>
        © 2024 中药代煎 系统
    </footer>

    <script>
        // 打开弹窗
        function openModal() {
            document.getElementById('editModal').classList.add('active');
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }
    </script>
</body>
</html>
```

**register.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户注册</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <!-- 导航栏 -->
    <div class="navbar">
        <a href="/" class="logo">中药代煎系统</a>
    </div>

    <div class="container">
        <h2>用户注册</h2>

        <!-- Flash 消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {% if category == 'danger' %}flash-message-danger{% else %}flash-message{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- 注册表单 -->
        <form method="POST" action="/register" id="registerForm">
            <label for="username">用户名:</label>
            <input type="text" id="username" name="username" placeholder="请输入用户名" required>

            <label for="password">密码:</label>
            <input type="password" id="password" name="password" placeholder="请输入密码" required>

            <label for="name">姓名:</label>
            <input type="text" id="name" name="name" placeholder="请输入姓名" required>

            <label for="gender">性别:</label>
            <select name="gender" id="gender" required>
                <option value="">请选择性别</option>
                <option value="男">男</option>
                <option value="女">女</option>
            </select>

            <label for="age">年龄:</label>
            <input type="number" id="age" name="age" placeholder="请输入年龄" required>

            <label for="contact_number">联系方式:</label>
            <input type="text" id="contact_number" name="contact_number" placeholder="请输入联系方式" required>

            <input type="hidden" name="role" value="patient"> <!-- 固定角色为患者 -->

            <button type="submit">注册</button>
        </form>
    </div>

    <script>
        document.getElementById('registerForm').addEventListener('submit', function (e) {
            // 客户端验证用户名
            const username = document.getElementById('username').value.trim();
            const messageElement = document.getElementById('message');

            if (username === "") {
                messageElement.textContent = "用户名不能为空";
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
```

**update_task.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>更新任务状态</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>更新任务状态</h1>

    <!-- 显示任务详情 -->
    <div class="task-details">
        <h2>任务详情</h2>
        <table>
            <tr>
                <th>任务 ID</th>
                <td>{{ task.task_id }}</td>
            </tr>
            <tr>
                <th>处方 ID</th>
                <td>{{ task.prescription_id }}</td>
            </tr>
            <tr>
                <th>当前状态</th>
                <td>{{ task.status }}</td>
            </tr>
            <tr>
                <th>收方时间</th>
                <td>{{ task.receive_time if task.receive_time else '未完成' }}</td>
            </tr>
            <tr>
                <th>配方时间</th>
                <td>{{ task.form_time if task.form_time else '未完成' }}</td>
            </tr>
            <tr>
                <th>煎药开始时间</th>
                <td>{{ task.decoction_start_time if task.decoction_start_time else '未开始' }}</td>
            </tr>
            <tr>
                <th>煎药结束时间</th>
                <td>{{ task.decoction_end_time if task.decoction_end_time else '未完成' }}</td>
            </tr>
        </table>
    </div>



    <!-- 任务操作 -->
    <div class="task-actions">
        <form method="POST">
            {% if task.receive_worker_id == session['role_id'] and not task.receive_time %}
            <button type="submit" name="action" value="receive">完成收方</button>
            {% elif task.form_worker_id == session['role_id'] and not task.form_time %}
            <button type="submit" name="action" value="formulate">完成配方</button>
            {% elif task.decoction_worker_id == session['role_id'] and not task.decoction_start_time %}
            <button type="submit" name="action" value="decoction_start">开始煎药</button>
            {% elif task.decoction_worker_id == session['role_id'] and not task.decoction_end_time %}
            <button type="submit" name="action" value="decoction_end">完成煎药</button>
            {% else %}
            <p>当前任务无可操作步骤或已完成。</p>
            {% endif %}
        </form>
    </div>

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**worker_profile.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工人信息</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>工人信息</h1>

    <!-- 显示工人信息 -->
    <h2>基本信息</h2>
    <table>
        <tr>
            <th>UUID</th>
            <td>{{ session.get('user_id') }}</td>
        </tr>
        <tr>
            <th>工人 ID</th>
            <td>{{ worker.worker_id }}</td>
        </tr>
        <tr>
            <th>姓名</th>
            <td>{{ worker.name }}</td>
        </tr>
        <tr>
            <th>年龄</th>
            <td>{{ worker.age }}</td>
        </tr>
        <tr>
            <th>联系方式</th>
            <td>{{ worker.contact_number }}</td>
        </tr>
    </table>

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**worker_tasks.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的任务</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="navbar">
        <a href="/dashboard" class="logo">中药代煎系统</a>
        <div>
            {% if session['role'] == 'admin' %}
                <a href="/admin/profile">个人信息</a>
                <a href="/admin/users">用户管理</a>
                <a href="/admin/assign_tasks">分配任务</a>
            {% elif session['role'] == 'patient' %}
                <a href="/patient/profile">个人信息</a>
                <a href="/patient/prescriptions">查看处方</a>
            {% elif session['role'] == 'doctor' %}
                <a href="/doctor/profile">个人信息</a>
                <a href="/doctor/prescriptions">我的处方</a>
                <a href="/doctor/prescriptions/new">开新处方</a>
            {% elif session['role'] == 'worker' %}
                <a href="/worker/profile">个人信息</a>
                <a href="/worker/tasks">我的任务</a>
            {% endif %}
            <a href="/logout">注销</a>
        </div>
    </div>

    <h1>我的任务</h1>

    <table>
        <thead>
            <tr>
                <th>任务 ID</th>
                <th>处方 ID</th>
                <th>任务阶段</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.task_id }}</td>
                <td>{{ task.prescription_id }}</td>
                <td>
                    {% if task.receive_worker_id == session['role_id'] %}
                    收方任务
                    {% elif task.form_worker_id == session['role_id'] %}
                    配方任务
                    {% elif task.decoction_worker_id == session['role_id'] %}
                    煎药任务
                    {% endif %}
                </td>
                <td>
                    {% if task.status == '完成' %}
                    已完成
                    {% else %}
                    进行中
                    {% endif %}
                </td>
                <td>
                    {% if task.status != '完成' %}
                    <a href="{{ url_for('update_task_status', task_id=task.task_id) }}">更新状态</a>
                    {% else %}
                    无操作
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <footer>
        © 2024 中药代煎 系统
    </footer>
</body>
</html>
```

**style.css**

```css
/* 全局设置 */
body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f9;
    color: #333;
    margin: 0;
    padding: 0;
}

h1, h2 {
    color: #444;
    text-align: center;
    margin: 20px 0;
}

a {
    color: #0066cc;
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

p {
    text-align: center;
    margin: 10px;
    font-size: 16px;
}

/* 表单样式 */
form {
    max-width: 400px;
    margin: 50px auto;
    background: #ffffff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

form label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
}

form input[type="text"],
form input[type="password"],
form button {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

form input[type="text"]:focus,
form input[type="password"]:focus {
    border-color: #0066cc;
    outline: none;
}

/* 按钮样式 */
button {
    background-color: #0066cc;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
}

button:hover {
    background-color: #004d99;
}

/* 表格样式 */
table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
    background: #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

table th,
table td {
    text-align: left;
    padding: 10px;
    border: 1px solid #ddd;
    font-size: 14px;
}

table th {
    background-color: #0066cc;
    color: white;
    font-weight: bold;
}

table tr:nth-child(even) {
    background-color: #f9f9f9;
}

/* 导航栏样式 */
.navbar {
    background-color: #0066cc;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    font-size: 18px;
}

.navbar a {
    color: white;
    text-decoration: none;
    margin: 0 10px;
}

.navbar a:hover {
    text-decoration: underline;
}

/* 页脚样式 */
footer {
    background-color: #444;
    color: white;
    text-align: center;
    padding: 10px 0;
    margin-top: 20px;
    font-size: 14px;
}

.dashboard-options {
    margin: 20px auto;
    max-width: 800px;
    text-align: left;
}

.dashboard-options h3 {
    color: #0066cc;
    margin-bottom: 10px;
}

.dashboard-options ul {
    list-style-type: none;
    padding: 0;
}

.dashboard-options li {
    margin: 10px 0;
}

.dashboard-options a {
    font-size: 16px;
    color: #0066cc;
    text-decoration: none;
}

.dashboard-options a:hover {
    text-decoration: underline;
}

.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #007bff;
    padding: 10px 20px;
    color: white;
}
.navbar a {
    color: white;
    text-decoration: none;
    margin-right: 15px;
}
.navbar a:hover {
    text-decoration: underline;
}
.navbar .logo {
    font-size: 1.5em;
    font-weight: bold;
}
```

